__事件循环（Event Loop）__ 是 JavaScript 运行时环境中的一个重要概念，它负责管理和执行异步任务。事件循环使得 JavaScript 可以处理非阻塞的 I/O 操作，使得程序在执行异步任务时不需要等待，而是可以继续执行其他任务。


__事件队列（Event Queue）__ 是事件循环中的一个组成部分，用于存储异步任务的回调函数。当异步任务完成并准备好执行其回调函数时，这些回调函数会被放入事件队列中等待执行。事件循环会不断地检查事件队列，当主线程空闲时，会从事件队列中取出一个回调函数，并将其执行，然后继续检查事件队列中是否还有其他任务需要执行。

简而言之，事件循环负责不断地从事件队列中取出任务执行，使得 JavaScript 可以有效地处理异步操作，提高了程序的性能和响应速度。

在 JavaScript 中，宏任务（macrotask）和微任务（microtask）是用于管理 __异步代码__ 执行顺序的重要概念。

- **宏任务（macrotask）**：宏任务是由浏览器提供的任务队列中执行的任务。常见的宏任务包括

1. setTimeout
2. setInterval
3. requestAnimationFrame
4. I/O 操作等。

当执行一个宏任务时，会等待任务完成后再执行下一个宏任务，因此它们之间有一个较大的时间间隔。

- **微任务（microtask）**：微任务是在 JavaScript 引擎内部的微队列中执行的任务。常见的微任务包括

1. Promise 的 then 方法
2. async/await(promise)
3. MutationObserver 的回调函数等。

:::abstract
先同后异，主线程轮询, 先微后宏,
:::

微任务会在当前任务执行结束后立即执行，因此它们的优先级比宏任务要高，且微任务队列会在每个任务执行结束后立即清空。

这两者之间的区别在于执行时机和优先级，了解它们有助于更好地理解 JavaScript 中的异步编程。

{{macro-micro-task.mermaid}}
[[macro-micro-task.mermaid]]

## 调用栈在处理同步任务和异步任务时有所不同

1. **同步任务**：
   当执行同步任务时，函数调用会按照顺序一个接一个地被添加到调用栈中，并按照后进先出（LIFO）的顺序执行。也就是说，最后被添加到调用栈的函数会最先执行，直到调用栈为空。

2. **异步任务**：
   异步任务在执行时，通常**不会立即进入调用栈执行，而是被放入任务队列中等待执行**。当满足某些条件时（比如网络请求完成、定时器到期等），异步任务会被推送到任务队列中。然后，事件循环会不断地从任务队列中取出任务，并将其放入调用栈中执行。

总的来说，同步任务会立即执行，而异步任务会在满足特定条件时才被执行。异步任务的执行顺序不是由调用栈决定的，而是由事件循环和任务队列协同决定的。
{{sync-async-task.mermaid}}
[[sync-async-task.mermaid]]
{{events.mermaid}}
[[events.mermaid]]

:::tip
异步事件的执行更像是一个trigger, 满足条件后就触发了。
:::

:::tip
对于宏任务和微任务的嵌套， 执行流程遵循DFS深度优先。 宏任务优先级小于微任务。
:::

【字节前端面试真题解析：彻底打通事件循环(Event Loop)及事件队列(Event Queue)机制、同步异步、宏任务微任务】 https://www.bilibili.com/video/BV1GV411s7G6/?p=3&share_source=copy_web&vd_source=96bbb7beeae76632120bcfdbb20a632f